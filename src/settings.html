<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración del Sistema - InstallWin#</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Estilos para el encabezado fijo de la tabla */
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Estilos para el loader */
        #loadingState {
            backdrop-filter: blur(5px);
        }
        
        /* Estilos para las tarjetas de estadísticas */
        .card .card-body {
            transition: all 0.3s ease;
        }
        
        .card:hover .card-body {
            transform: translateY(-5px);
        }
        
        /* Animación para el botón de actualizar */
        #refreshButton .bi-arrow-clockwise {
            transition: transform 0.5s ease;
        }
        
        #refreshButton:hover .bi-arrow-clockwise {
            transform: rotate(180deg);
        }

        /* Estilos para las pestañas */
        .nav-tabs .nav-link {
            color: #495057;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }

        .nav-tabs .nav-link.active {
            color: #0078d4;
            background-color: #fff;
            border-bottom-color: transparent;
            font-weight: 600;
        }

        /* Estilos para el editor de términos y condiciones */
        #termsEditor {
            min-height: 300px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="login.html">
                <img src="InstallWin#.svg" alt="InstallWin#" height="30" class="me-2">
                InstallWin#
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="bi bi-house-fill me-2 text-white"></i>
                            Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people-fill me-2 text-white"></i>
                            Usuarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="apps.html">
                            <i class="bi bi-microsoft me-2 text-white"></i>
                            Aplicaciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="settings.html">
                            <i class="bi bi-gear me-2 text-white"></i>
                            Configuración
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="currentUserName">Usuario</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="logoutButton"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container main-container">
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-gear me-2"></i>Configuración del Sistema</h2>
                <p class="text-muted">Administra la configuración general de la aplicación</p>
            </div>
            <div class="col-auto">
                <button id="refreshButton" class="btn btn-outline-primary me-2">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Actualizar
                </button>
                <button id="saveConfigButton" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Estado de carga -->
        <div id="loadingState" class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center d-none" style="z-index: 1050; background-color: rgba(255, 255, 255, 0.8);">
            <div class="card shadow" style="width: 400px;">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <h5 class="card-title" id="loadingTitle">Cargando configuración</h5>
                    <p class="card-text" id="loadingMessage">Obteniendo datos desde SharePoint...</p>
                    <div class="progress mt-3" style="height: 15px;">
                        <div id="loadingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="loadingProgressText" class="mt-2 text-muted">Preparando...</p>
                </div>
            </div>
        </div>

        <!-- Pestañas de navegación -->
        <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="course-tab" data-bs-toggle="tab" data-bs-target="#course" type="button" role="tab">
                    <i class="bi bi-mortarboard me-1"></i> Curso
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos" type="button" role="tab">
                    <i class="bi bi-play-circle me-1"></i> Videos Importantes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="terms-tab" data-bs-toggle="tab" data-bs-target="#terms" type="button" role="tab">
                    <i class="bi bi-file-text me-1"></i> Términos y Condiciones
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="settingsTabsContent">
            <!-- Pestaña: Curso -->
            <div class="tab-pane fade show active" id="course" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-mortarboard me-2"></i>Configuración del Curso</h5>
                    </div>
                    <div class="card-body">
                        <form id="courseForm">
                            <div class="mb-3">
                                <label for="courseTitle" class="form-label">Título del Curso</label>
                                <input type="text" class="form-control" id="courseTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="courseVideoUrl" class="form-label">URL del Video</label>
                                <input type="url" class="form-control" id="courseVideoUrl" required>
                                <div class="form-text">Introduce la URL de YouTube (se convertirá automáticamente al formato de incrustación)</div>
                            </div>
                            <div class="mb-3">
                                <label for="courseDescription" class="form-label">Descripción del Curso</label>
                                <textarea class="form-control" id="courseDescription" rows="3" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="paymentUrl" class="form-label">URL de Pago con Tarjeta</label>
                                        <input type="url" class="form-control" id="paymentUrl">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="whatsappUrl" class="form-label">URL de WhatsApp</label>
                                        <input type="url" class="form-control" id="whatsappUrl">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6>Vista Previa</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 id="courseTitlePreview">Título del Curso</h5>
                                        <div class="ratio ratio-16x9 mb-3">
                                            <iframe id="courseVideoPreview" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                        </div>
                                        <div id="courseDescriptionPreview" class="mb-3">Descripción del curso...</div>
                                        <div class="d-flex gap-2">
                                            <a href="#" id="paymentUrlPreview" class="btn btn-primary" target="_blank">
                                                <i class="bi bi-credit-card me-1"></i> Pagar con Tarjeta
                                            </a>
                                            <a href="#" id="whatsappUrlPreview" class="btn btn-success" target="_blank">
                                                <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Videos Importantes -->
            <div class="tab-pane fade" id="videos" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Videos Importantes</h5>
                    </div>
                    <div class="card-body">
                        <form id="videosForm">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2">Video de Windows Defender</h6>
                                    <div class="mb-3">
                                        <label for="defenderVideoTitle" class="form-label">Título</label>
                                        <input type="text" class="form-control" id="defenderVideoTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="defenderVideoUrl" class="form-label">URL del Video</label>
                                        <input type="url" class="form-control" id="defenderVideoUrl" required>
                                    </div>
                                    <div class="ratio ratio-16x9 mb-3">
                                        <iframe id="defenderVideoPreview" src="" title="Windows Defender video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2">Video de ESET Security</h6>
                                    <div class="mb-3">
                                        <label for="esetVideoTitle" class="form-label">Título</label>
                                        <input type="text" class="form-control" id="esetVideoTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="esetVideoUrl" class="form-label">URL del Video</label>
                                        <input type="url" class="form-control" id="esetVideoUrl" required>
                                    </div>
                                    <div class="ratio ratio-16x9 mb-3">
                                        <iframe id="esetVideoPreview" src="" title="ESET Security video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="antivirusWarning" class="form-label">Advertencia sobre Antivirus</label>
                                <textarea class="form-control" id="antivirusWarning" rows="3"></textarea>
                                <div class="form-text">Este mensaje se mostrará como advertencia en la sección de antivirus</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Términos y Condiciones -->
            <div class="tab-pane fade" id="terms" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Términos y Condiciones</h5>
                    </div>
                    <div class="card-body">
                        <form id="termsForm">
                            <div class="mb-3">
                                <label for="termsEditor" class="form-label">Contenido de los Términos y Condiciones</label>
                                <div id="termsEditorContainer" class="border rounded p-2">
                                    <div class="btn-toolbar mb-2" role="toolbar">
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="boldBtn" title="Negrita"><i class="bi bi-type-bold"></i></button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="italicBtn" title="Cursiva"><i class="bi bi-type-italic"></i></button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="underlineBtn" title="Subrayado"><i class="bi bi-type-underline"></i></button>
                                        </div>
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="h1Btn" title="Título 1">H1</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="h2Btn" title="Título 2">H2</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="h3Btn" title="Título 3">H3</button>
                                        </div>
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="ulBtn" title="Lista con viñetas"><i class="bi bi-list-ul"></i></button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="olBtn" title="Lista numerada"><i class="bi bi-list-ol"></i></button>
                                        </div>
                                    </div>
                                    <div contenteditable="true" id="termsEditor" class="form-control" style="min-height: 300px; max-height: 500px; overflow-y: auto;"></div>
                                </div>
                                <div class="form-text mt-2">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Usa los controles de formato para dar estilo al texto. El contenido se guardará en formato RTF para compatibilidad con la aplicación de escritorio.
                                </div>
                                <div class="form-text mt-2">
                                    <i class="bi bi-clock-history me-1"></i>
                                    Última modificación: <span id="lastModifiedDate">No disponible</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vista previa</label>
                                <div class="card">
                                    <div class="card-body">
                                        <div id="termsPreview" class="terms-preview p-3" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Los términos y condiciones se mostrarán a los usuarios durante el proceso de instalación y deberán aceptarlos para continuar.
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src="js/sharepoint-auth.js"></script>
    <script src="js/sharepoint-graph.js"></script>
    
    <script>
        // Variables globales
        let auth, spGraph;
        let appSettings = null;
        
        // Referencias DOM
        const loadingState = document.getElementById('loadingState');
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingProgressText = document.getElementById('loadingProgressText');
        const alertContainer = document.getElementById('alertContainer');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const refreshButton = document.getElementById('refreshButton');
        
        // Referencias DOM - Curso
        const courseTitle = document.getElementById('courseTitle');
        const courseVideoUrl = document.getElementById('courseVideoUrl');
        const courseDescription = document.getElementById('courseDescription');
        const paymentUrl = document.getElementById('paymentUrl');
        const whatsappUrl = document.getElementById('whatsappUrl');
        const courseTitlePreview = document.getElementById('courseTitlePreview');
        const courseVideoPreview = document.getElementById('courseVideoPreview');
        const courseDescriptionPreview = document.getElementById('courseDescriptionPreview');
        const paymentUrlPreview = document.getElementById('paymentUrlPreview');
        const whatsappUrlPreview = document.getElementById('whatsappUrlPreview');
        
        // Referencias DOM - Videos
        const defenderVideoTitle = document.getElementById('defenderVideoTitle');
        const defenderVideoUrl = document.getElementById('defenderVideoUrl');
        const esetVideoTitle = document.getElementById('esetVideoTitle');
        const esetVideoUrl = document.getElementById('esetVideoUrl');
        const antivirusWarning = document.getElementById('antivirusWarning');
        const defenderVideoPreview = document.getElementById('defenderVideoPreview');
        const esetVideoPreview = document.getElementById('esetVideoPreview');
        
        // Referencias DOM - Términos
        const termsEditor = document.getElementById('termsEditor');
        const lastModifiedDate = document.getElementById('lastModifiedDate');
        const termsPreview = document.getElementById('termsPreview');
        
        // Referencias DOM - Botones de formato
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const h1Btn = document.getElementById('h1Btn');
        const h2Btn = document.getElementById('h2Btn');
        const h3Btn = document.getElementById('h3Btn');
        const ulBtn = document.getElementById('ulBtn');
        const olBtn = document.getElementById('olBtn');
        
        // Inicializar editor básico
        function initBasicEditor() {
            // Configurar botones de formato
            boldBtn.addEventListener('click', () => execFormatCommand('bold'));
            italicBtn.addEventListener('click', () => execFormatCommand('italic'));
            underlineBtn.addEventListener('click', () => execFormatCommand('underline'));
            h1Btn.addEventListener('click', () => execFormatCommand('formatBlock', '<h1>'));
            h2Btn.addEventListener('click', () => execFormatCommand('formatBlock', '<h2>'));
            h3Btn.addEventListener('click', () => execFormatCommand('formatBlock', '<h3>'));
            ulBtn.addEventListener('click', () => execFormatCommand('insertUnorderedList'));
            olBtn.addEventListener('click', () => execFormatCommand('insertOrderedList'));
            
            // Actualizar vista previa cuando cambie el contenido
            termsEditor.addEventListener('input', updateTermsPreview);
        }
        
        // Ejecutar comando de formato
        function execFormatCommand(command, value = null) {
            document.execCommand(command, false, value);
            termsEditor.focus();
            updateTermsPreview();
        }
        
        // Convertir HTML a RTF mejorado
        function htmlToRtf(html) {
            // Encabezado RTF básico
            let rtf = '{\\rtf1\\ansi\\ansicpg1252\\uc1\\htmautsp\\deff2{\\fonttbl{\\f0\\fcharset0 Times New Roman;}{\\f2\\fcharset0 Segoe UI;}{\\f3\\fcharset0 Aptos;}}{\\colortbl\\red0\\green0\\blue0;\\red255\\green255\\blue255;} {\\*\\listtable {\\list\\listtemplateid1\\listhybrid {\\listlevel\\levelnfc23\\levelnfcn23\\leveljc0\\leveljcn0\\levelfollow0\\levelstartat1\\levelspace0\\levelindent0{\\leveltext\\leveltemplateid5\\\'01\\\'b7}{\\levelnumbers;}\\fi-360\\li720\\lin720\\jclisttab\\tx720} {\\listlevel\\levelnfc0\\levelnfcn0\\leveljc0\\leveljcn0\\levelfollow0\\levelstartat1\\levelspace0\\levelindent0{\\leveltext\\leveltemplateid6\\\'02\\\'01.;}{\\levelnumbers\\\'01;}\\fi-360\\li1440\\lin1440\\jclisttab\\tx1440} {\\listlevel\\levelnfc0\\levelnfcn0\\leveljc0\\leveljcn0\\levelfollow0\\levelstartat1\\levelspace0\\levelindent0{\\leveltext\\leveltemplateid7\\\'02\\\'02.;}{\\levelnumbers\\\'01;}\\fi-360\\li2160\\lin2160\\jclisttab\\tx2160} {\\listlevel\\levelnfc0\\levelnfcn0\\leveljc0\\leveljcn0\\levelfollow0\\levelstartat1\\levelspace0\\levelindent0{\\leveltext\\leveltemplateid8\\\'02\\\'03.;}{\\levelnumbers\\\'01;}\\fi-360\\li2880\\lin2880\\jclisttab\\tx2880}}}\n\n';
            
            // Crear un elemento temporal para procesar el HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Función recursiva para procesar nodos
            function processNode(node, rtfContent = '') {
                if (node.nodeType === Node.TEXT_NODE) {
                    // Escapar caracteres especiales de RTF
                    return node.textContent
                        .replace(/\\/g, '\\\\')
                        .replace(/\{/g, '\\{')
                        .replace(/\}/g, '\\}')
                        .replace(/\n/g, '\\par\n');
                }
                
                if (node.nodeType === Node.ELEMENT_NODE) {
                    let content = '';
                    let prefix = '';
                    let suffix = '';
                    
                    // Aplicar formato según el tipo de elemento
                    switch (node.nodeName.toLowerCase()) {
                        case 'b':
                        case 'strong':
                            prefix = '{\\b ';
                            suffix = '}';
                            break;
                        case 'i':
                        case 'em':
                            prefix = '{\\i ';
                            suffix = '}';
                            break;
                        case 'u':
                            prefix = '{\\ul ';
                            suffix = '}';
                            break;
                        case 'h1':
                            prefix = '{\\fs36\\b ';
                            suffix = '}\\par\n';
                            break;
                        case 'h2':
                            prefix = '{\\fs28\\b ';
                            suffix = '}\\par\n';
                            break;
                        case 'h3':
                            prefix = '{\\fs24\\b ';
                            suffix = '}\\par\n';
                            break;
                        case 'p':
                            suffix = '\\par\n';
                            break;
                        case 'br':
                            return '\\par\n';
                        case 'ul':
                        case 'ol':
                            // No añadir prefijo/sufijo especial, se maneja en los elementos li
                            break;
                        case 'li':
                            prefix = '\\bullet ';
                            suffix = '\\par\n';
                            break;
                        default:
                            // Para otros elementos, solo procesar su contenido
                            break;
                    }
                    
                    // Procesar nodos hijos
                    for (const child of node.childNodes) {
                        content += processNode(child);
                    }
                    
                    return prefix + content + suffix;
                }
                
                return '';
            }
            
            // Procesar el contenido HTML
            let content = '';
            for (const child of tempDiv.childNodes) {
                content += processNode(child);
            }
            
            // Si no hay contenido o solo hay espacios en blanco, agregar un párrafo vacío
            if (!content.trim()) {
                content = '\\par\n';
            }
            
            rtf += content + '}';
            return rtf;
        }
        
        // Actualizar vista previa de términos y condiciones
        function updateTermsPreview() {
            termsPreview.innerHTML = termsEditor.innerHTML || 'No hay términos y condiciones definidos.';
        }
        
        // Convertir RTF a HTML
        function rtfToHtml(rtf) {
            // Si no hay contenido RTF, devolver cadena vacía
            if (!rtf || rtf.trim() === '') {
                return '';
            }
            
            try {
                console.log('RTF original:', rtf);
                
                // Detectar si es un formato RTF específico de la aplicación de escritorio
                if (rtf.includes('\\listlevel\\levelnfc') || rtf.includes('\\leveltext\\leveltemplateid')) {
                    console.log('Detectado formato RTF específico de la aplicación de escritorio');
                    
                    // Extraer el texto principal del RTF
                    let mainText = '';
                    
                    // Buscar secciones de texto significativas
                    const textMatches = rtf.match(/\\f\d+\\fcharset\d+\s+([^\\{}]+)/g) || [];
                    const ltrchMatches = rtf.match(/\\ltrch\s+([^\\{}]+)/g) || [];
                    const plainTextMatches = rtf.match(/[^\\{}]+/g) || [];
                    
                    // Combinar todas las coincidencias de texto
                    const allTextMatches = [...textMatches, ...ltrchMatches, ...plainTextMatches];
                    
                    // Filtrar y limpiar el texto extraído
                    allTextMatches.forEach(match => {
                        let text = match
                            .replace(/\\f\d+\\fcharset\d+\s+/, '')
                            .replace(/\\ltrch\s+/, '')
                            .trim();
                        
                        // Solo agregar texto significativo (más de 3 caracteres y no solo números o símbolos)
                        if (text.length > 3 && /[a-zA-ZáéíóúÁÉÍÓÚñÑ]/.test(text)) {
                            mainText += text + '\n';
                        }
                    });
                    
                    console.log('Texto extraído:', mainText);
                    
                    // Extraer título principal
                    let title = '';
                    const titleMatch = mainText.match(/Términos y Condiciones de Uso[^\\}]+/i) || 
                                      rtf.match(/Términos y Condiciones de Uso[^\\}]+/i);
                    if (titleMatch) {
                        title = `<h1>${titleMatch[0].trim()}</h1>`;
                    } else {
                        title = '<h1>Términos y Condiciones de Uso</h1>';
                    }
                    
                    // Extraer información de versión y fecha
                    let appInfo = '';
                    const versionMatch = mainText.match(/Versi[óo]n:\s*([^\\}\n]+)/i) || 
                                        rtf.match(/Versi[óo]n:\s*([^\\}\n]+)/i);
                    if (versionMatch) {
                        appInfo += `<p><strong>Versión:</strong> ${versionMatch[1].trim()}</p>`;
                    }
                    
                    const dateMatch = mainText.match(/Actualizado el\s+([^\\}\n)]+)/i) || 
                                     rtf.match(/Actualizado el\s+([^\\}\n)]+)/i);
                    if (dateMatch) {
                        appInfo += `<p><strong>Actualizado:</strong> ${dateMatch[1].trim()}</p>`;
                    }
                    
                    // Extraer secciones numeradas
                    let content = '';
                    const sectionRegex = /(\d+)\.\s+([^\\}\n.]+)(?:\.|:)?/g;
                    let sectionMatch;
                    
                    // Buscar secciones numeradas en el texto extraído
                    while ((sectionMatch = sectionRegex.exec(mainText)) !== null) {
                        const sectionNum = sectionMatch[1];
                        const sectionTitle = sectionMatch[2].trim();
                        
                        if (sectionTitle.length > 3) {  // Evitar coincidencias falsas
                            content += `<h2>${sectionNum}. ${sectionTitle}</h2>`;
                            
                            // Buscar el contenido de esta sección (texto entre esta sección y la siguiente)
                            const sectionStart = mainText.indexOf(sectionMatch[0]) + sectionMatch[0].length;
                            const nextSectionMatch = new RegExp(`${parseInt(sectionNum) + 1}\\.\\s+`, 'i').exec(mainText.substring(sectionStart));
                            const sectionEnd = nextSectionMatch ? sectionStart + nextSectionMatch.index : mainText.length;
                            
                            // Extraer y formatear el contenido de la sección
                            let sectionContent = mainText.substring(sectionStart, sectionEnd).trim();
                            if (sectionContent) {
                                // Dividir en párrafos y formatear
                                const paragraphs = sectionContent.split(/\n\s*\n/).filter(p => p.trim());
                                paragraphs.forEach(paragraph => {
                                    // Detectar si es una lista
                                    if (paragraph.includes('•') || /^\s*[\-\*]\s+/.test(paragraph)) {
                                        const items = paragraph.split(/•|\n\s*[\-\*]\s+/).filter(item => item.trim());
                                        if (items.length > 0) {
                                            content += '<ul>';
                                            items.forEach(item => {
                                                if (item.trim()) {
                                                    content += `<li>${item.trim()}</li>`;
                                                }
                                            });
                                            content += '</ul>';
                                        }
                                    } else {
                                        content += `<p>${paragraph.trim()}</p>`;
                                    }
                                });
                            }
                        }
                    }
                    
                    // Si no pudimos extraer secciones estructuradas, usar el texto plano
                    if (!content) {
                        // Dividir por líneas y convertir a párrafos
                        const lines = mainText.split('\n').filter(line => line.trim());
                        content = lines.map(line => {
                            // Detectar si es un título
                            if (/^\d+\.\s+/.test(line)) {
                                return `<h2>${line.trim()}</h2>`;
                            }
                            // Detectar si es un elemento de lista
                            else if (line.includes('•') || /^\s*[\-\*]\s+/.test(line)) {
                                return `<li>${line.replace(/^[•\-\*]\s+/, '').trim()}</li>`;
                            }
                            // Párrafo normal
                            else {
                                return `<p>${line.trim()}</p>`;
                            }
                        }).join('');
                        
                        // Asegurarse de que las listas estén correctamente formateadas
                        content = content.replace(/<li>.*?<\/li>/g, match => {
                            if (!content.includes('<ul>')) {
                                return '<ul>' + match + '</ul>';
                            }
                            return match;
                        });
                    }
                    
                    // Combinar todo
                    const htmlResult = title + appInfo + content;
                    console.log('HTML generado:', htmlResult);
                    return htmlResult;
                }
                
                // Para RTF más simple, usar el enfoque original
                // Extraer el contenido de texto del RTF
                let content = rtf;
                
                // Eliminar el encabezado RTF
                content = content.replace(/^{\\rtf1.*?\\par\s*/s, '');
                
                // Eliminar el cierre final
                content = content.replace(/}$/, '');
                
                // Manejar códigos de nivel específicos
                content = content.replace(/\\listlevel.*?\\tx\d+/g, '');
                content = content.replace(/\\leveltext.*?}/g, '');
                content = content.replace(/\\levelnumbers.*?}/g, '');
                content = content.replace(/\\leveljc\d+\\leveljcn\d+/g, '');
                content = content.replace(/\\levelfollow\d+\\levelstartat\d+/g, '');
                content = content.replace(/\\levelspace\d+\\levelindent\d+/g, '');
                content = content.replace(/\\fi-\d+\\li\d+\\lin\d+\\jclisttab/g, '');
                
                // Manejar códigos de formato específicos
                content = content.replace(/\\f\d+\\fcharset\d+/g, '');
                content = content.replace(/\\ansicpg\d+\\uc\d+\\htmautsp/g, '');
                content = content.replace(/\\deff\d+/g, '');
                content = content.replace(/\\red\d+\\green\d+\\blue\d+/g, '');
                
                // Extraer secciones de texto significativas
                const textSections = content.match(/\\ltrch\s+([^\\}]+)/g) || [];
                if (textSections.length > 0) {
                    content = textSections.map(section => 
                        section.replace(/\\ltrch\s+/, '')
                    ).join('\n');
                }
                
                // Extraer secciones numeradas (como "1. Aceptación de los Términos y Condiciones:")
                const numberedSections = content.match(/\d+\.\s+[^\\}]+/g) || [];
                if (numberedSections.length > 0) {
                    let htmlContent = '';
                    numberedSections.forEach(section => {
                        htmlContent += `<h2>${section.trim()}</h2>`;
                    });
                    
                    if (htmlContent) {
                        // Agregar título principal si lo encontramos
                        const titleMatch = content.match(/Términos y Condiciones de Uso/);
                        if (titleMatch) {
                            htmlContent = `<h1>Términos y Condiciones de Uso (Descargo de Responsabilidad)</h1>` + htmlContent;
                        }
                        
                        return htmlContent;
                    }
                }
                
                // Si no pudimos extraer secciones estructuradas, intentar con el enfoque general
                
                // Convertir códigos RTF básicos a HTML
                content = content
                    // Párrafos
                    .replace(/\\par\s*/g, '</p><p>')
                    // Negrita
                    .replace(/{\\b\s+([^}]*)}/g, '<strong>$1</strong>')
                    // Cursiva
                    .replace(/{\\i\s+([^}]*)}/g, '<em>$1</em>')
                    // Subrayado
                    .replace(/{\\ul\s+([^}]*)}/g, '<u>$1</u>')
                    // Tamaños de fuente para títulos
                    .replace(/{\\fs36\\b\s+([^}]*)}/g, '<h1>$1</h1>')
                    .replace(/{\\fs28\\b\s+([^}]*)}/g, '<h2>$1</h2>')
                    .replace(/{\\fs24\\b\s+([^}]*)}/g, '<h3>$1</h3>')
                    // Viñetas
                    .replace(/\\bullet\s+([^\\]*)(\\par|$)/g, '<li>$1</li>')
                    // Limpiar caracteres de escape
                    .replace(/\\\\/g, '\\')
                    .replace(/\\{/g, '{')
                    .replace(/\\}/g, '}');
                
                // Envolver en párrafos si es necesario
                if (!content.startsWith('<')) {
                    content = '<p>' + content;
                }
                if (!content.endsWith('>')) {
                    content += '</p>';
                }
                
                // Asegurarse de que las listas estén correctamente formateadas
                content = content.replace(/<li>.*?<\/li>/g, match => {
                    if (!content.includes('<ul>')) {
                        return '<ul>' + match + '</ul>';
                    }
                    return match;
                });
                
                // Limpiar párrafos vacíos y etiquetas mal formadas
                content = content
                    .replace(/<p><\/p>/g, '')
                    .replace(/<p><h([1-6])>/g, '<h$1>')
                    .replace(/<\/h([1-6])><\/p>/g, '</h$1>')
                    .replace(/<p><ul>/g, '<ul>')
                    .replace(/<\/ul><\/p>/g, '</ul>');
                
                // Si después de todo el procesamiento no tenemos contenido HTML válido,
                // crear un HTML básico con el texto extraído
                if (!content.includes('<')) {
                    content = content.split('\n')
                        .filter(line => line.trim())
                        .map(line => `<p>${line.trim()}</p>`)
                        .join('');
                }
                
                console.log('HTML convertido:', content);
                return content;
            } catch (error) {
                console.error('Error al convertir RTF a HTML:', error);
                // Crear un HTML básico con el texto del error y un mensaje para el usuario
                return `
                    <h1>Términos y Condiciones</h1>
                    <p>El contenido está en formato RTF. Por favor, edite manualmente para dar formato.</p>
                    <p><em>Error de conversión: ${error.message}</em></p>
                `;
            }
        }
        
        // Guardar configuración
        async function saveConfiguration() {
            try {
                showLoading(true, 'Guardando configuración', 'Enviando datos a SharePoint...');
                updateProgress(0, 'Preparando configuración...');
                
                // Obtener contenido del editor
                const htmlContent = termsEditor.innerHTML;
                
                // Convertir a RTF para compatibilidad con la aplicación de escritorio
                const rtfContent = htmlToRtf(htmlContent);
                
                // Crear objeto de configuración
                const updatedSettings = {
                    Course: {
                        Title: courseTitle.value,
                        VideoUrl: courseVideoUrl.value,
                        Description: courseDescription.value,
                        Links: {
                            CardPayment: paymentUrl.value,
                            WhatsApp: whatsappUrl.value
                        }
                    },
                    Videos: {
                        DefenderVideoTitle: defenderVideoTitle.value,
                        DefenderVideoUrl: defenderVideoUrl.value,
                        EsetVideoTitle: esetVideoTitle.value,
                        EsetVideoUrl: esetVideoUrl.value,
                        AntivirusWarning: antivirusWarning.value
                    },
                    TermsAndConditions: {
                        Content: rtfContent, // Guardar en formato RTF
                        HtmlContent: htmlContent, // También guardar el HTML para la web
                        LastModified: new Date().toISOString()
                    }
                };
                
                updateProgress(50, 'Guardando configuración...');
                
                // Guardar configuración
                await spGraph.saveAppSettings(updatedSettings);
                
                // Actualizar la configuración local
                appSettings = updatedSettings;
                
                // Actualizar fecha de última modificación
                if (appSettings.TermsAndConditions && appSettings.TermsAndConditions.LastModified) {
                    const date = new Date(appSettings.TermsAndConditions.LastModified);
                    lastModifiedDate.textContent = date.toLocaleString();
                }
                
                updateProgress(100, '¡Configuración guardada!');
                setTimeout(() => {
                    showLoading(false);
                    showAlert('success', 'Configuración guardada correctamente');
                }, 500);
                
            } catch (error) {
                console.error('Error al guardar la configuración:', error);
                showLoading(false);
                showAlert('danger', `Error al guardar la configuración: ${error.message}`);
            }
        }
        
        // Cargar configuración
        async function loadConfiguration() {
            try {
                showLoading(true);
                updateProgress(10, 'Conectando con SharePoint...');
                
                // Obtener la configuración
                const response = await spGraph.getAppSettings();
                appSettings = response;
                
                updateProgress(50, 'Actualizando interfaz...');
                
                // Actualizar formulario de curso
                if (appSettings.Course) {
                    courseTitle.value = appSettings.Course.Title || '';
                    courseVideoUrl.value = appSettings.Course.VideoUrl || '';
                    courseDescription.value = appSettings.Course.Description || '';
                    
                    if (appSettings.Course.Links) {
                        paymentUrl.value = appSettings.Course.Links.CardPayment || '';
                        whatsappUrl.value = appSettings.Course.Links.WhatsApp || '';
                    }
                    
                    // Actualizar vista previa
                    updateCoursePreview();
                }
                
                // Actualizar formulario de videos
                if (appSettings.Videos) {
                    defenderVideoTitle.value = appSettings.Videos.DefenderVideoTitle || '';
                    defenderVideoUrl.value = appSettings.Videos.DefenderVideoUrl || '';
                    esetVideoTitle.value = appSettings.Videos.EsetVideoTitle || '';
                    esetVideoUrl.value = appSettings.Videos.EsetVideoUrl || '';
                    antivirusWarning.value = appSettings.Videos.AntivirusWarning || '';
                    
                    // Actualizar vista previa
                    updateVideosPreview();
                }
                
                // Actualizar formulario de términos
                if (appSettings.TermsAndConditions) {
                    let htmlContent = '';
                    
                    // Preferir el contenido HTML si está disponible
                    if (appSettings.TermsAndConditions.HtmlContent && appSettings.TermsAndConditions.HtmlContent.trim() !== '') {
                        htmlContent = appSettings.TermsAndConditions.HtmlContent;
                        console.log('Usando contenido HTML existente');
                    } 
                    // Si no hay HTML pero hay RTF, convertir RTF a HTML
                    else if (appSettings.TermsAndConditions.Content && appSettings.TermsAndConditions.Content.trim() !== '') {
                        console.log('Convirtiendo RTF a HTML');
                        htmlContent = rtfToHtml(appSettings.TermsAndConditions.Content);
                        
                        // Guardar la versión HTML convertida para futuras cargas
                        if (htmlContent && htmlContent !== '') {
                            appSettings.TermsAndConditions.HtmlContent = htmlContent;
                            
                            // Guardar silenciosamente la versión actualizada con el HTML convertido
                            setTimeout(async () => {
                                try {
                                    await spGraph.saveAppSettings(appSettings);
                                    console.log('Versión HTML guardada correctamente');
                                } catch (error) {
                                    console.error('Error al guardar la versión HTML convertida:', error);
                                }
                            }, 1000);
                        }
                    }
                    
                    // Actualizar el editor con el contenido HTML
                    if (htmlContent && htmlContent.trim() !== '') {
                        termsEditor.innerHTML = htmlContent;
                    } else {
                        termsEditor.innerHTML = '<p>No hay términos y condiciones definidos. Agregue contenido aquí.</p>';
                    }
                    
                    if (appSettings.TermsAndConditions.LastModified) {
                        const date = new Date(appSettings.TermsAndConditions.LastModified);
                        lastModifiedDate.textContent = date.toLocaleString();
                    } else {
                        lastModifiedDate.textContent = 'No disponible';
                    }
                    
                    // Actualizar vista previa de términos
                    updateTermsPreview();
                }
                
                updateProgress(100, '¡Configuración cargada!');
                setTimeout(() => {
                    showLoading(false);
                    showAlert('success', 'Configuración cargada correctamente');
                }, 500);
                
            } catch (error) {
                console.error('Error al cargar la configuración:', error);
                showLoading(false);
                showAlert('danger', `Error al cargar la configuración: ${error.message}`);
            }
        }
        
        // Actualizar vista previa del curso
        function updateCoursePreview() {
            courseTitlePreview.textContent = courseTitle.value || 'Título del Curso';
            courseDescriptionPreview.innerHTML = courseDescription.value || 'Descripción del curso...';
            
            // Actualizar video
            const embedUrl = convertToEmbedUrl(courseVideoUrl.value);
            courseVideoPreview.src = embedUrl;
            
            // Actualizar enlaces
            paymentUrlPreview.href = paymentUrl.value || '#';
            whatsappUrlPreview.href = whatsappUrl.value || '#';
        }
        
        // Actualizar vista previa de videos
        function updateVideosPreview() {
            // Actualizar videos
            const defenderEmbedUrl = convertToEmbedUrl(defenderVideoUrl.value);
            const esetEmbedUrl = convertToEmbedUrl(esetVideoUrl.value);
            
            defenderVideoPreview.src = defenderEmbedUrl;
            esetVideoPreview.src = esetEmbedUrl;
        }
        
        // Convertir URL de YouTube a formato de incrustación
        function convertToEmbedUrl(url) {
            if (!url) return '';
            
            // Si ya es una URL de incrustación, devolverla tal cual
            if (url.includes('youtube.com/embed/')) {
                return url;
            }
            
            // Extraer el ID del video de diferentes formatos de URL de YouTube
            let videoId = '';
            
            // Formato: https://www.youtube.com/watch?v=VIDEO_ID
            if (url.includes('youtube.com/watch')) {
                const urlParams = new URLSearchParams(new URL(url).search);
                videoId = urlParams.get('v');
            } 
            // Formato: https://youtu.be/VIDEO_ID
            else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            }
            
            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            
            // Si no se pudo extraer el ID, devolver la URL original
            return url;
        }
        
        // Funciones auxiliares
        function showLoading(show, title = 'Cargando configuración', message = 'Obteniendo datos desde SharePoint...') {
            if (show) {
                loadingTitle.textContent = title;
                loadingMessage.textContent = message;
                loadingState.classList.remove('d-none');
                document.body.style.overflow = 'hidden'; // Prevenir scroll
            } else {
                loadingState.classList.add('d-none');
                document.body.style.overflow = ''; // Restaurar scroll
            }
        }
        
        function updateProgress(percent, message) {
            loadingProgressBar.style.width = `${percent}%`;
            loadingProgressBar.setAttribute('aria-valuenow', percent);
            loadingProgressText.textContent = message;
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
        
        // Configurar eventos
        function setupEventListeners() {
            // Botón de guardar
            saveConfigButton.addEventListener('click', saveConfiguration);
            
            // Botón de actualizar
            refreshButton.addEventListener('click', loadConfiguration);
            
            // Eventos para actualizar vista previa del curso
            courseTitle.addEventListener('input', updateCoursePreview);
            courseDescription.addEventListener('input', updateCoursePreview);
            courseVideoUrl.addEventListener('input', updateCoursePreview);
            paymentUrl.addEventListener('input', updateCoursePreview);
            whatsappUrl.addEventListener('input', updateCoursePreview);
            
            // Eventos para actualizar vista previa de videos
            defenderVideoUrl.addEventListener('input', updateVideosPreview);
            esetVideoUrl.addEventListener('input', updateVideosPreview);
            
            // Botón de cerrar sesión
            document.getElementById('logoutButton').addEventListener('click', function() {
                auth.logout();
            });
        }
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log("Inicializando la aplicación...");
                
                // Inicializar editor básico
                initBasicEditor();
                
                // Inicializar autenticación
                auth = new SharePointAuth();
                
                try {
                    // Verificar si hay una respuesta de redirección o una sesión existente
                    await auth.initialize();
                    
                    // Verificar si el usuario está autenticado
                    if (!auth.isAuthenticated()) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Actualizar el nombre de usuario en la interfaz
                    const currentUserNameElement = document.getElementById('currentUserName');
                    if (currentUserNameElement && auth.user) {
                        currentUserNameElement.textContent = auth.user.name || auth.user.username;
                        console.log("Nombre de usuario actualizado:", auth.user.name || auth.user.username);
                    }
                    
                    // Inicializar componentes
                    spGraph = new SharePointGraph(auth);
                    window.spGraph = spGraph; // Hacer disponible globalmente
                    
                    // Configurar eventos
                    setupEventListeners();
                    
                    // Cargar configuración
                    await loadConfiguration();
                    
                } catch (error) {
                    console.error('Error al inicializar la aplicación:', error);
                    showAlert('danger', `Error al inicializar la aplicación: ${error.message}`);
                }
            } catch (error) {
                console.error('Error al inicializar la aplicación:', error);
                showAlert('danger', `Error al inicializar la aplicación: ${error.message}`);
            }
        });
    </script>
</body>
</html> 