<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración del Sistema - InstallWin#</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Estilos para el encabezado fijo de la tabla */
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Estilos para el loader */
        #loadingState {
            backdrop-filter: blur(5px);
        }
        
        /* Estilos para las tarjetas de estadísticas */
        .card .card-body {
            transition: all 0.3s ease;
        }
        
        .card:hover .card-body {
            transform: translateY(-5px);
        }
        
        /* Animación para el botón de actualizar */
        #refreshButton .bi-arrow-clockwise {
            transition: transform 0.5s ease;
        }
        
        #refreshButton:hover .bi-arrow-clockwise {
            transform: rotate(180deg);
        }

        /* Estilos para las pestañas */
        .nav-tabs .nav-link {
            color: #495057;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }

        .nav-tabs .nav-link.active {
            color: #0078d4;
            background-color: #fff;
            border-bottom-color: transparent;
            font-weight: 600;
        }

        /* Estilos para el editor de términos y condiciones */
        #termsEditor {
            min-height: 300px;
            resize: vertical;
        }
        
        /* Estilos para la vista previa estilo WhatsApp */
        .whatsapp-style {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: #303030;
        }
        
        .whatsapp-style strong {
            font-weight: 600;
        }
        
        .whatsapp-style em {
            font-style: italic;
        }
        
        .whatsapp-style del {
            text-decoration: line-through;
        }
        
        .whatsapp-style code {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .whatsapp-style a {
            color: #0078d4;
            text-decoration: none;
        }
        
        .whatsapp-style a:hover {
            text-decoration: underline;
        }
        
        /* Estilos para emojis y viñetas */
        .whatsapp-style ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        
        .whatsapp-style li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="login.html">
                <img src="InstallWin.svg" alt="InstallWin#" height="30" class="me-2">
                InstallWin#
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">
                            <i class="bi bi-house-fill me-2 text-white"></i>
                            Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people-fill me-2 text-white"></i>
                            Usuarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="apps.html">
                            <i class="bi bi-microsoft me-2 text-white"></i>
                            Aplicaciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="settings.html">
                            <i class="bi bi-gear me-2 text-white"></i>
                            Configuración
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="currentUserName">Usuario</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="logoutButton"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container main-container">
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-gear me-2"></i>Configuración del Sistema</h2>
                <p class="text-muted">Administra la configuración general de la aplicación</p>
            </div>
            <div class="col-auto">
                <button id="refreshButton" class="btn btn-outline-primary me-2">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Actualizar
                </button>
                <button id="saveConfigButton" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Estado de carga -->
        <div id="loadingState" class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center d-none" style="z-index: 1050; background-color: rgba(255, 255, 255, 0.8);">
            <div class="card shadow" style="width: 400px;">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <h5 class="card-title" id="loadingTitle">Cargando configuración</h5>
                    <p class="card-text" id="loadingMessage">Obteniendo datos desde SharePoint...</p>
                    <div class="progress mt-3" style="height: 15px;">
                        <div id="loadingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="loadingProgressText" class="mt-2 text-muted">Preparando...</p>
                </div>
            </div>
        </div>

        <!-- Pestañas de navegación -->
        <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="course-tab" data-bs-toggle="tab" data-bs-target="#course" type="button" role="tab">
                    <i class="bi bi-mortarboard me-1"></i> Curso
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos" type="button" role="tab">
                    <i class="bi bi-play-circle me-1"></i> Videos Importantes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="terms-tab" data-bs-toggle="tab" data-bs-target="#terms" type="button" role="tab">
                    <i class="bi bi-file-text me-1"></i> Términos y Condiciones
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="settingsTabsContent">
            <!-- Pestaña: Curso -->
            <div class="tab-pane fade show active" id="course" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-mortarboard me-2"></i>Configuración del Curso</h5>
                    </div>
                    <div class="card-body">
                        <form id="courseForm">
                            <div class="mb-3">
                                <label for="courseTitle" class="form-label">Título del Curso</label>
                                <input type="text" class="form-control" id="courseTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="courseVideoUrl" class="form-label">URL del Video</label>
                                <input type="url" class="form-control" id="courseVideoUrl" required>
                                <div class="form-text">Introduce la URL de YouTube (se convertirá automáticamente al formato de incrustación)</div>
                            </div>
                            <div class="mb-3">
                                <label for="courseDescription" class="form-label">Descripción del Curso</label>
                                <textarea class="form-control" id="courseDescription" rows="6" required></textarea>
                                <div class="form-text">Puedes usar formatos como *negrita*, _cursiva_, ~tachado~, ```código```, y URLs que se convertirán en enlaces.</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="paymentUrl" class="form-label">URL de Pago con Tarjeta</label>
                                        <input type="url" class="form-control" id="paymentUrl">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="whatsappUrl" class="form-label">URL de WhatsApp</label>
                                        <input type="url" class="form-control" id="whatsappUrl">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6>Vista Previa</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 id="courseTitlePreview">Título del Curso</h5>
                                        <div class="ratio ratio-16x9 mb-3">
                                            <iframe id="courseVideoPreview" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                        </div>
                                        <div id="courseDescriptionPreview" class="mb-3 whatsapp-style" style="white-space: pre-wrap; border: 1px solid #e9ecef; border-radius: 0.25rem; padding: 10px; background-color: #f8f9fa; max-height: 300px; overflow-y: auto;">Descripción del curso...</div>
                                        <div class="d-flex gap-2">
                                            <a href="#" id="paymentUrlPreview" class="btn btn-primary" target="_blank">
                                                <i class="bi bi-credit-card me-1"></i> Pagar con Tarjeta
                                            </a>
                                            <a href="#" id="whatsappUrlPreview" class="btn btn-success" target="_blank">
                                                <i class="bi bi-whatsapp me-1"></i> Contactar por WhatsApp
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Videos Importantes -->
            <div class="tab-pane fade" id="videos" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Videos Importantes</h5>
                    </div>
                    <div class="card-body">
                        <form id="videosForm">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2">Video de Windows Defender</h6>
                                    <div class="mb-3">
                                        <label for="defenderVideoTitle" class="form-label">Título</label>
                                        <input type="text" class="form-control" id="defenderVideoTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="defenderVideoUrl" class="form-label">URL del Video</label>
                                        <input type="url" class="form-control" id="defenderVideoUrl" required>
                                    </div>
                                    <div class="ratio ratio-16x9 mb-3">
                                        <iframe id="defenderVideoPreview" src="" title="Windows Defender video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2">Video de ESET Security</h6>
                                    <div class="mb-3">
                                        <label for="esetVideoTitle" class="form-label">Título</label>
                                        <input type="text" class="form-control" id="esetVideoTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="esetVideoUrl" class="form-label">URL del Video</label>
                                        <input type="url" class="form-control" id="esetVideoUrl" required>
                                    </div>
                                    <div class="ratio ratio-16x9 mb-3">
                                        <iframe id="esetVideoPreview" src="" title="ESET Security video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="antivirusWarning" class="form-label">Advertencia sobre Antivirus</label>
                                <textarea class="form-control" id="antivirusWarning" rows="3"></textarea>
                                <div class="form-text">Este mensaje se mostrará como advertencia en la sección de antivirus</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Términos y Condiciones -->
            <div class="tab-pane fade" id="terms" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Términos y Condiciones</h5>
                    </div>
                    <div class="card-body">
                        <form id="termsForm">
                            <div class="mb-3">
                                <label for="termsEditor" class="form-label">Contenido de los Términos y Condiciones</label>
                                <div id="termsEditorContainer" class="border rounded p-2">
                                    <div class="btn-toolbar mb-2" role="toolbar">
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="boldBtn" title="Negrita"><i class="bi bi-type-bold"></i></button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="italicBtn" title="Cursiva"><i class="bi bi-type-italic"></i></button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="underlineBtn" title="Subrayado"><i class="bi bi-type-underline"></i></button>
                                        </div>
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="h1Btn" title="Título 1">H1</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="h2Btn" title="Título 2">H2</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="h3Btn" title="Título 3">H3</button>
                                        </div>
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="ulBtn" title="Lista con viñetas"><i class="bi bi-list-ul"></i></button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="olBtn" title="Lista numerada"><i class="bi bi-list-ol"></i></button>
                                        </div>
                                    </div>
                                    <div contenteditable="true" id="termsEditor" class="form-control" style="min-height: 300px; max-height: 500px; overflow-y: auto;"></div>
                                </div>
                                <div class="form-text mt-2">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Usa los controles de formato para dar estilo al texto. El contenido se guardará en formato RTF para compatibilidad con la aplicación de escritorio.
                                </div>
                                <div class="form-text mt-2">
                                    <i class="bi bi-clock-history me-1"></i>
                                    Última modificación: <span id="lastModifiedDate">No disponible</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vista previa</label>
                                <div class="card">
                                    <div class="card-body">
                                        <div id="termsPreview" class="terms-preview p-3" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Los términos y condiciones se mostrarán a los usuarios durante el proceso de instalación y deberán aceptarlos para continuar.
                            </div>
                            <div class="mt-3">
                                <button type="button" id="forceConversionBtn" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    Forzar conversión RTF a HTML
                                </button>
                                <small class="text-muted ms-2">Usar solo para depuración</small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src="js/sharepoint-auth.js"></script>
    <script src="js/sharepoint-graph.js"></script>
    
    <script>
        // Variables globales
        let auth, spGraph;
        let appSettings = null;
        
        // Referencias DOM
        const loadingState = document.getElementById('loadingState');
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingProgressText = document.getElementById('loadingProgressText');
        const alertContainer = document.getElementById('alertContainer');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const refreshButton = document.getElementById('refreshButton');
        
        // Referencias DOM - Curso
        const courseTitle = document.getElementById('courseTitle');
        const courseVideoUrl = document.getElementById('courseVideoUrl');
        const courseDescription = document.getElementById('courseDescription');
        const paymentUrl = document.getElementById('paymentUrl');
        const whatsappUrl = document.getElementById('whatsappUrl');
        const courseTitlePreview = document.getElementById('courseTitlePreview');
        const courseVideoPreview = document.getElementById('courseVideoPreview');
        const courseDescriptionPreview = document.getElementById('courseDescriptionPreview');
        const paymentUrlPreview = document.getElementById('paymentUrlPreview');
        const whatsappUrlPreview = document.getElementById('whatsappUrlPreview');
        
        // Referencias DOM - Videos
        const defenderVideoTitle = document.getElementById('defenderVideoTitle');
        const defenderVideoUrl = document.getElementById('defenderVideoUrl');
        const esetVideoTitle = document.getElementById('esetVideoTitle');
        const esetVideoUrl = document.getElementById('esetVideoUrl');
        const antivirusWarning = document.getElementById('antivirusWarning');
        const defenderVideoPreview = document.getElementById('defenderVideoPreview');
        const esetVideoPreview = document.getElementById('esetVideoPreview');
        
        // Referencias DOM - Términos
        const termsEditor = document.getElementById('termsEditor');
        const lastModifiedDate = document.getElementById('lastModifiedDate');
        const termsPreview = document.getElementById('termsPreview');
        
        // Referencias DOM - Botones de formato
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const h1Btn = document.getElementById('h1Btn');
        const h2Btn = document.getElementById('h2Btn');
        const h3Btn = document.getElementById('h3Btn');
        const ulBtn = document.getElementById('ulBtn');
        const olBtn = document.getElementById('olBtn');
        
        // Inicializar editor básico
        function initBasicEditor() {
            // Configurar botones de formato
            boldBtn.addEventListener('click', () => execFormatCommand('bold'));
            italicBtn.addEventListener('click', () => execFormatCommand('italic'));
            underlineBtn.addEventListener('click', () => execFormatCommand('underline'));
            h1Btn.addEventListener('click', () => execFormatCommand('formatBlock', '<h1>'));
            h2Btn.addEventListener('click', () => execFormatCommand('formatBlock', '<h2>'));
            h3Btn.addEventListener('click', () => execFormatCommand('formatBlock', '<h3>'));
            ulBtn.addEventListener('click', () => execFormatCommand('insertUnorderedList'));
            olBtn.addEventListener('click', () => execFormatCommand('insertOrderedList'));
            
            // Actualizar vista previa cuando cambie el contenido
            termsEditor.addEventListener('input', updateTermsPreview);
        }
        
        // Ejecutar comando de formato
        function execFormatCommand(command, value = null) {
            document.execCommand(command, false, value);
            termsEditor.focus();
            updateTermsPreview();
        }
        
        // Convertir HTML a RTF mejorado
        function htmlToRtf(html) {
            // Encabezado RTF básico compatible con WPF RichTextBox
            let rtf = '{\\rtf1\\ansi\\ansicpg1252\\deff0\\nouicompat\\deflang3082{\\fonttbl{\\f0\\fnil\\fcharset0 Segoe UI;}{\\f1\\fnil\\fcharset0 Calibri;}}';
            rtf += '{\\colortbl ;\\red0\\green0\\blue0;}';
            rtf += '\\viewkind4\\uc1\\pard\\sa200\\sl276\\slmult1\\f0\\fs22\\lang10';
            
            // Crear un elemento temporal para procesar el HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Eliminar elementos no deseados (style, script, etc.)
            const elementsToRemove = tempDiv.querySelectorAll('style, script, head');
            elementsToRemove.forEach(el => el.remove());
            
            // Función recursiva para procesar nodos
            function processNode(node, rtfContent = '') {
                if (node.nodeType === Node.TEXT_NODE) {
                    // Escapar caracteres especiales de RTF
                    return escapeRtf(node.textContent);
                }
                
                if (node.nodeType === Node.ELEMENT_NODE) {
                    let content = '';
                    let prefix = '';
                    let suffix = '';
                    
                    // Aplicar formato según el tipo de elemento
                    switch (node.nodeName.toLowerCase()) {
                        case 'b':
                        case 'strong':
                            prefix = '\\b ';
                            suffix = '\\b0 ';
                            break;
                        case 'i':
                        case 'em':
                            prefix = '\\i ';
                            suffix = '\\i0 ';
                            break;
                        case 'u':
                            prefix = '\\ul ';
                            suffix = '\\ul0 ';
                            break;
                        case 'h1':
                            prefix = '\\pard\\sa200\\sl276\\slmult1\\qc\\b\\fs32 ';
                            suffix = '\\b0\\par\n';
                            break;
                        case 'h2':
                            prefix = '\\pard\\sa200\\sl276\\slmult1\\b\\fs28 ';
                            suffix = '\\b0\\par\n';
                            break;
                        case 'h3':
                            prefix = '\\pard\\sa200\\sl276\\slmult1\\b\\fs24 ';
                            suffix = '\\b0\\par\n';
                            break;
                        case 'p':
                            if (node.className === 'bold') {
                                prefix = '\\pard\\sa200\\sl276\\slmult1\\b ';
                                suffix = '\\b0\\par\n';
                            } else {
                                prefix = '\\pard\\sa200\\sl276\\slmult1 ';
                                suffix = '\\par\n';
                            }
                            break;
                        case 'br':
                            return '\\line ';
                        case 'ul':
                            // No añadir prefijo/sufijo especial, se maneja en los elementos li
                            break;
                        case 'li':
                            prefix = '\\pard\\sa200\\sl276\\slmult1\\fi-360\\li720\\bullet ';
                            suffix = '\\par\n';
                            break;
                        case 'a':
                            prefix = '\\ul\\cf1 ';
                            suffix = '\\ul0\\cf0 ';
                            break;
                        default:
                            // Para otros elementos, solo procesar su contenido
                            break;
                    }
                    
                    // Procesar nodos hijos
                    for (const child of node.childNodes) {
                        content += processNode(child);
                    }
                    
                    return prefix + content + suffix;
                }
                
                return '';
            }
            
            // Procesar el contenido HTML
            let content = '';
            for (const child of tempDiv.childNodes) {
                content += processNode(child);
            }
            
            // Si no hay contenido o solo hay espacios en blanco, agregar un párrafo vacío
            if (!content.trim()) {
                content = '\\par\n';
            }
            
            // Finalizar el RTF
            rtf += content + '}';
            return rtf;
        }
        
        // Función para escapar caracteres especiales en RTF
        function escapeRtf(text) {
            if (!text) return '';
            
            return text
                .replace(/\\/g, '\\\\')
                .replace(/\{/g, '\\{')
                .replace(/\}/g, '\\}')
                .replace(/\n/g, '\\par ')
                .replace(/á/g, '\\\'e1')
                .replace(/é/g, '\\\'e9')
                .replace(/í/g, '\\\'ed')
                .replace(/ó/g, '\\\'f3')
                .replace(/ú/g, '\\\'fa')
                .replace(/ñ/g, '\\\'f1')
                .replace(/Á/g, '\\\'c1')
                .replace(/É/g, '\\\'c9')
                .replace(/Í/g, '\\\'cd')
                .replace(/Ó/g, '\\\'d3')
                .replace(/Ú/g, '\\\'da')
                .replace(/Ñ/g, '\\\'d1')
                .replace(/ü/g, '\\\'fc')
                .replace(/Ü/g, '\\\'dc')
                .replace(/©/g, '\\\'a9');
        }
        
        // Convertir RTF a HTML
        function rtfToHtml(rtf) {
            // Si no hay contenido RTF, devolver cadena vacía
            if (!rtf || rtf.trim() === '') {
                console.warn('rtfToHtml: No hay contenido RTF para convertir');
                return '';
            }
            
            try {
                console.log('rtfToHtml: Iniciando conversión, longitud RTF:', rtf.length);
                
                // Buscar el inicio del contenido real
                const contentStart = rtf.indexOf('\\ltrpar\\itap0');
                if (contentStart === -1) {
                    throw new Error('No se pudo encontrar el contenido RTF válido');
                }

                // Extraer el contenido
                let content = rtf.substring(contentStart);
                
                // Crear el HTML base
                let html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Términos y Condiciones - Instaladores de Windows Online C#</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #000;
            background-color: #fff;
        }
        h1, h2 {
            color: #000;
        }
        ul {
            padding-left: 40px;
        }
        .bold {
            font-weight: bold;
        }
    </style>
</head>
<body>`;

                // Extraer y procesar párrafos
                const paragraphs = content.split('\\par');
                
                // Variables para seguimiento
                let isInList = false;
                let foundWarning = false;
                let foundTermsTitle = false;
                let foundMetadata = false;
                
                // Para el título principal
                for (let i = 0; i < paragraphs.length; i++) {
                    let paragraph = paragraphs[i].trim();
                    
                    // Título "Términos y Condiciones"
                    if (paragraph.includes('rminos y Condiciones de Uso') && !foundTermsTitle) {
                        const title = extractCleanText(paragraph);
                        html += `\n    <h1>${title}</h1>\n`;
                        foundTermsTitle = true;
                        continue;
                    }
                    
                    // Metadatos (Aplicación, Versión, etc.)
                    if (paragraph.includes('Aplicaci') && paragraph.includes('Versi') && !foundMetadata) {
                        html += `\n    <p>\n`;
                        
                        // Procesar cada parte de los metadatos
                        const metaLabels = ['Aplicación:', 'Versión:', 'Empresa:', 'Derechos Reservados:'];
                        let metaText = extractCleanText(paragraph);
                        
                        for (let label of metaLabels) {
                            if (metaText.includes(label)) {
                                const startIdx = metaText.indexOf(label);
                                let endIdx;
                                
                                // Encontrar dónde termina esta etiqueta
                                if (label === 'Derechos Reservados:') {
                                    endIdx = metaText.length;
                                } else {
                                    const nextLabel = metaLabels[metaLabels.indexOf(label) + 1];
                                    endIdx = metaText.indexOf(nextLabel);
                                }
                                
                                if (endIdx > startIdx) {
                                    const value = metaText.substring(startIdx + label.length, endIdx).trim();
                                    html += `        <span class="bold">${label}</span> ${value} `;
                                }
                            }
                        }
                        
                        html += `\n    </p>\n`;
                        foundMetadata = true;
                        continue;
                    }
                    
                    // Advertencia en negrita
                    if (paragraph.includes('POR FAVOR, LEA ESTOS') && !foundWarning) {
                        let warning = extractCleanText(paragraph);
                        html += `\n    <p class="bold">\n        ${warning}\n    </p>\n`;
                        foundWarning = true;
                        continue;
                    }
                    
                    // Procesar secciones numeradas
                    const sectionMatch = paragraph.match(/(\d+)\.\s+([^:]+):/);
                    if (sectionMatch) {
                        // Si estábamos en una lista, cerrarla
                        if (isInList) {
                            html += `    </ul>\n`;
                            isInList = false;
                        }
                        
                        const sectionTitle = extractCleanText(paragraph);
                        html += `\n    <h2>${sectionTitle}</h2>\n`;
                        
                        // Caso especial para "Restricciones de Uso"
                        if (sectionTitle.includes("3. Restricciones de Uso")) {
                            continue;
                        }
                        
                        continue;
                    }
                    
                    // Mensaje "Usted se compromete a NO:"
                    if (paragraph.includes('Usted se compromete a NO:')) {
                        html += `    <p>Usted se compromete a NO:</p>\n`;
                        html += `    <ul>\n`;
                        isInList = true;
                        continue;
                    }
                    
                    // Elementos de lista (viñetas)
                    if (paragraph.includes('\\pntext') || paragraph.includes('\\\'B7')) {
                        if (!isInList) {
                            html += `    <ul>\n`;
                            isInList = true;
                        }
                        
                        let listContent = extractCleanText(paragraph);
                        const isBold = paragraph.includes('\\b\\ltrch');
                        
                        html += `        <li${isBold ? ' class="bold"' : ''}>${listContent}</li>\n`;
                        continue;
                    }
                    
                    // Cierra la lista si estamos saliendo de ella y entrando a otra sección
                    if (isInList && paragraph.includes('4. Descargo')) {
                        html += `    </ul>\n`;
                        isInList = false;
                    }
                    
                    // Párrafos normales y especiales
                    if (paragraph.length > 10 && 
                        !paragraph.includes('\\ltrpar\\itap0') && 
                        !paragraph.includes('\\pntext') && 
                        !paragraph.includes('\\fonttbl') &&
                        !paragraph.includes('\\colortbl') &&
                        !paragraph.includes('\\listlevel')) {
                            
                        let text = extractCleanText(paragraph);
                        
                        // Omitir párrafos que ya hemos procesado
                        if (text.includes('Términos y Condiciones de Uso') || 
                            text.includes('Aplicación:') || 
                            text.includes('POR FAVOR, LEA ESTOS') ||
                            text.includes('Usted se compromete a NO:') ||
                            text.length < 5) {
                            continue;
                        }
                        
                        // Manejo especial de los párrafos de la sección "Descargo de Responsabilidad"
                        if (paragraph.includes('Edudigital. LATAM no se hace responsable por ning')) {
                            html += `    <p class="bold">\n        ${text}\n    </p>\n`;
                            continue;
                        }
                        
                        if (paragraph.includes('Edudigital. LATAM no se hace responsable por el uso indebido')) {
                            html += `    <p class="bold">\n        ${text}\n    </p>\n`;
                            continue;
                        }
                        
                        // Sección de contacto con enlace
                        if (paragraph.includes('Si tiene alguna pregunta')) {
                            text = text.replace(/(https?:\/\/[^\s\.]+\.[^\s]+)/g, '<a href="$1">$1</a>');
                            html += `    <p>\n        ${text}\n    </p>\n`;
                            continue;
                        }
                        
                        // Pie de página (copyright)
                        if (paragraph.includes('2025 Edudigital. LATAM. Todos los derechos reservados') && 
                            !paragraph.includes('Aplicación:')) {
                            html += `    <p class="bold">${text}</p>\n`;
                            continue;
                        }
                        
                        // Párrafos normales
                        if (text.trim()) {
                            html += `    <p>\n        ${text}\n    </p>\n`;
                        }
                    }
                }
                
                // Cerrar el documento
                html += `</body>\n</html>`;
                
                return html;
            } catch (error) {
                console.error('rtfToHtml: Error al convertir RTF a HTML:', error);
                
                // Método de respaldo en caso de error
                try {
                    console.log('rtfToHtml: Intentando método de respaldo');
                    
                    // Extraer texto plano eliminando códigos RTF
                    let plainText = rtf
                        .replace(/{\\rtf1.*?}/gs, '')
                        .replace(/\\~/g, ' ')
                        .replace(/\.\s*\\~\s*/g, '. ')
                        .replace(/\\[a-z0-9]+/g, ' ')
                        .replace(/\{|\}/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    // Crear HTML básico
                    let fallbackHtml = `
                        <h1>Términos y Condiciones</h1>
                        <p>El contenido original está en formato RTF. A continuación se muestra una versión simplificada:</p>
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; background-color: #f9f9f9;">
                            ${plainText.split(/\.\s+/).map(sentence => `<p>${sentence.trim()}.</p>`).join('')}
                        </div>
                        <p><em>Nota: Esta es una versión simplificada. Para ver el formato completo, edite manualmente el contenido.</em></p>
                    `;
                    
                    console.log('rtfToHtml: HTML de respaldo generado');
                    return fallbackHtml;
                    
                } catch (backupError) {
                    console.error('rtfToHtml: Error en el método de respaldo:', backupError);
                    return `
                        <h1>Términos y Condiciones</h1>
                        <p>No se pudo procesar el contenido RTF. Por favor, contacte al administrador.</p>
                        <p><em>Error: ${error.message}</em></p>
                    `;
                }
            }
        }
        
        // Funciones auxiliares para el conversor RTF a HTML
        function extractCleanText(rtfText) {
            // Eliminar todas las etiquetas RTF y extraer solo el contenido de texto
            let text = rtfText
                .replace(/\\ltrpar\\itap0.*?\\ql/g, '')
                .replace(/\\li\d+\\ri\d+\\sa\d+\\sb\d+\\fi\d+\\ql.*/g, '')
                .replace(/\\li\d+\\ri\d+\\sa\d+\\sb\d+\\jclisttab\\tx\d+\\fi-\d+\\ql.*/g, '')
                .replace(/\{\\lang\d+\\ltrch\s+/g, '')
                .replace(/\{\\lang\d+\\b\\ltrch\s+/g, '')
                .replace(/\{\\fs\d+\\f\d+(\\\w+)?\s+/g, '')
                .replace(/\{\\fs\d+\\f\d+\s+\{/g, '')
                .replace(/\{\\pntext\s+[^}]*\}\{[^}]*\}/g, '')
                .replace(/\\\*\\pn[^}]*\}/g, '')
                .replace(/\}\\\w+\d*\\ri\d+\\sa\d+\\sb\d+.*/g, '')
                .replace(/\{|\}/g, '')
                .replace(/\\ltrch\s+/g, '')
                .replace(/\\b\\ltrch\s+/g, '')
                .replace(/\\cf\d+\\ql/g, '')
                .replace(/\\~/g, '') // Eliminar \~
                .replace(/\\\w+\s?/g, '');
            
            // Limpieza final y eliminar espacios duplicados
            text = text.replace(/\s{2,}/g, ' ').trim();
            
            // Aplicar decodificación de caracteres RTF
            text = decodeRtfCharacters(text);
            
            return text;
        }

        function decodeRtfCharacters(text) {
            // Primero, buscar patrones de caracteres especiales RTF y reemplazarlos
            const rtfCharMap = {
                "\\'e9": "é",
                "\\'e1": "á",
                "\\'ed": "í",
                "\\'f3": "ó",
                "\\'fa": "ú",
                "\\'f1": "ñ",
                "\\'c1": "Á",
                "\\'c9": "É",
                "\\'cd": "Í",
                "\\'d3": "Ó",
                "\\'da": "Ú",
                "\\'d1": "Ñ",
                "\\'e0": "à",
                "\\'e8": "è",
                "\\'ec": "ì",
                "\\'f2": "ò",
                "\\'f9": "ù",
                "\\'c0": "À",
                "\\'c8": "È",
                "\\'cc": "Ì",
                "\\'d2": "Ò",
                "\\'d9": "Ù",
                "\\'a9": "©",
                "\u0027": "'",
                "\u0022": '"'
            };

            // Reemplazar todos los caracteres especiales
            for (let rtf in rtfCharMap) {
                text = text.replace(new RegExp(rtf.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rtfCharMap[rtf]);
            }

            // Proceso adicional para encontrar patrones como \á, \é, etc. y eliminar la barra invertida
            text = text.replace(/\\([áéíóúñÁÉÍÓÚÑàèìòùÀÈÌÒÙ©])/g, '$1');
            
            return text;
        }
        
        // Guardar configuración
        async function saveConfiguration() {
            try {
                showLoading(true, 'Guardando configuración', 'Enviando datos a SharePoint...');
                updateProgress(0, 'Preparando configuración...');
                
                // Obtener contenido del editor
                const htmlContent = termsEditor.innerHTML;
                
                // Convertir a RTF para compatibilidad con la aplicación de escritorio
                const rtfContent = htmlToRtf(htmlContent);
                
                // Crear objeto de configuración
                const updatedSettings = {
                    Course: {
                        Title: courseTitle.value,
                        VideoUrl: courseVideoUrl.value,
                        Description: courseDescription.value,
                        Links: {
                            CardPayment: paymentUrl.value,
                            WhatsApp: whatsappUrl.value
                        }
                    },
                    Videos: {
                        DefenderVideoTitle: defenderVideoTitle.value,
                        DefenderVideoUrl: defenderVideoUrl.value,
                        EsetVideoTitle: esetVideoTitle.value,
                        EsetVideoUrl: esetVideoUrl.value,
                        AntivirusWarning: antivirusWarning.value
                    },
                    TermsAndConditions: {
                        Content: rtfContent, // Guardar en formato RTF
                        // No guardar el HTML para evitar duplicidad y mantener solo el RTF
                        LastModified: new Date().toISOString()
                    }
                };
                
                updateProgress(50, 'Guardando configuración...');
                
                // Guardar configuración
                await spGraph.saveAppSettings(updatedSettings);
                
                // Actualizar la configuración local
                appSettings = updatedSettings;
                
                // Actualizar fecha de última modificación
                if (appSettings.TermsAndConditions && appSettings.TermsAndConditions.LastModified) {
                    const date = new Date(appSettings.TermsAndConditions.LastModified);
                    lastModifiedDate.textContent = date.toLocaleString();
                }
                
                updateProgress(100, '¡Configuración guardada!');
                setTimeout(() => {
                    showLoading(false);
                    showAlert('success', 'Configuración guardada correctamente');
                }, 500);
                
            } catch (error) {
                console.error('Error al guardar la configuración:', error);
                showLoading(false);
                showAlert('danger', `Error al guardar la configuración: ${error.message}`);
            }
        }
        
        // Cargar configuración
        async function loadConfiguration() {
            try {
                showLoading(true);
                updateProgress(10, 'Conectando con SharePoint...');
                
                // Obtener la configuración
                const response = await spGraph.getAppSettings();
                appSettings = response;
                
                updateProgress(50, 'Actualizando interfaz...');
                
                // Actualizar formulario de curso
                if (appSettings.Course) {
                    courseTitle.value = appSettings.Course.Title || '';
                    courseVideoUrl.value = appSettings.Course.VideoUrl || '';
                    courseDescription.value = appSettings.Course.Description || '';
                    
                    if (appSettings.Course.Links) {
                        paymentUrl.value = appSettings.Course.Links.CardPayment || '';
                        whatsappUrl.value = appSettings.Course.Links.WhatsApp || '';
                    }
                    
                    // Actualizar vista previa
                    updateCoursePreview();
                }
                
                // Actualizar formulario de videos
                if (appSettings.Videos) {
                    defenderVideoTitle.value = appSettings.Videos.DefenderVideoTitle || '';
                    defenderVideoUrl.value = appSettings.Videos.DefenderVideoUrl || '';
                    esetVideoTitle.value = appSettings.Videos.EsetVideoTitle || '';
                    esetVideoUrl.value = appSettings.Videos.EsetVideoUrl || '';
                    antivirusWarning.value = appSettings.Videos.AntivirusWarning || '';
                    
                    // Actualizar vista previa
                    updateVideosPreview();
                }
                
                // Actualizar formulario de términos
                if (appSettings.TermsAndConditions) {
                    let htmlContent = '';
                    
                    // Verificar si tenemos contenido RTF
                    if (appSettings.TermsAndConditions.Content) {
                        console.log('Contenido RTF disponible, longitud:', 
                            appSettings.TermsAndConditions.Content ? appSettings.TermsAndConditions.Content.length : 0);
                    } else {
                        console.warn('No hay contenido RTF disponible');
                    }
                    
                    // Verificar si tenemos contenido HTML
                    if (appSettings.TermsAndConditions.HtmlContent) {
                        console.log('Contenido HTML disponible, longitud:', 
                            appSettings.TermsAndConditions.HtmlContent ? appSettings.TermsAndConditions.HtmlContent.length : 0);
                    } else {
                        console.warn('No hay contenido HTML disponible');
                    }
                    
                    // Preferir el contenido HTML si está disponible
                    if (appSettings.TermsAndConditions.HtmlContent && appSettings.TermsAndConditions.HtmlContent.trim() !== '') {
                        htmlContent = appSettings.TermsAndConditions.HtmlContent;
                        console.log('Usando contenido HTML existente');
                    } 
                    // Si no hay HTML pero hay RTF, convertir RTF a HTML
                    else if (appSettings.TermsAndConditions.Content && appSettings.TermsAndConditions.Content.trim() !== '') {
                        console.log('Iniciando conversión de RTF a HTML...');
                        
                        // Mostrar una muestra del RTF para depuración
                        const rtfSample = appSettings.TermsAndConditions.Content.substring(0, 200) + '...';
                        console.log('Muestra del RTF:', rtfSample);
                        
                        // Llamar a la función de conversión
                        htmlContent = rtfToHtml(appSettings.TermsAndConditions.Content);
                        console.log('Conversión RTF a HTML completada');
                        
                        // No guardar la versión HTML - solo para visualización local
                        if (htmlContent && htmlContent !== '') {
                            console.log('HTML generado correctamente para visualización local');
                            // No almacenar en appSettings para evitar guardado automático
                        } else {
                            console.error('La conversión RTF a HTML no generó contenido válido');
                        }
                    } else {
                        console.warn('No hay contenido RTF ni HTML disponible');
                    }
                    
                    // Actualizar el editor con el contenido HTML
                    if (htmlContent && htmlContent.trim() !== '') {
                        termsEditor.innerHTML = htmlContent;
                        console.log('Editor actualizado con contenido HTML');
                    } else {
                        termsEditor.innerHTML = '<p>No hay términos y condiciones definidos. Agregue contenido aquí.</p>';
                        console.warn('No se encontró contenido para mostrar en el editor');
                    }
                    
                    if (appSettings.TermsAndConditions.LastModified) {
                        const date = new Date(appSettings.TermsAndConditions.LastModified);
                        lastModifiedDate.textContent = date.toLocaleString();
                    } else {
                        lastModifiedDate.textContent = 'No disponible';
                    }
                    
                    // Actualizar vista previa de términos
                    updateTermsPreview();
                } else {
                    console.warn('No hay sección de TermsAndConditions en la configuración');
                }
                
                updateProgress(100, '¡Configuración cargada!');
                setTimeout(() => {
                    showLoading(false);
                    showAlert('success', 'Configuración cargada correctamente');
                }, 500);
                
            } catch (error) {
                console.error('Error al cargar la configuración:', error);
                showLoading(false);
                showAlert('danger', `Error al cargar la configuración: ${error.message}`);
            }
        }
        
        // Actualizar vista previa del curso
        function updateCoursePreview() {
            courseTitlePreview.textContent = courseTitle.value || 'Título del Curso';
            
            // Formatear el texto como en WhatsApp
            let formattedText = courseDescription.value || 'Descripción del curso...';
            
            // Convertir formatos de WhatsApp a HTML
            formattedText = formattedText
                // Negrita: *texto* -> <strong>texto</strong>
                .replace(/\*([^*]+)\*/g, '<strong>$1</strong>')
                // Cursiva: _texto_ -> <em>texto</em>
                .replace(/\_([^_]+)\_/g, '<em>$1</em>')
                // Tachado: ~texto~ -> <del>texto</del>
                .replace(/\~([^~]+)\~/g, '<del>$1</del>')
                // Código: ```texto``` -> <code>texto</code>
                .replace(/\`\`\`([^`]+)\`\`\`/g, '<code style="background-color: #e9ecef; padding: 2px 4px; border-radius: 3px;">$1</code>')
                // URLs: convertir en enlaces clicables
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: #0078d4;">$1</a>')
                // Emojis: mantener como están
                // Saltos de línea: preservar
                .replace(/\n/g, '<br>');
            
            courseDescriptionPreview.innerHTML = formattedText;
            
            // Actualizar video
            const embedUrl = convertToEmbedUrl(courseVideoUrl.value);
            courseVideoPreview.src = embedUrl;
            
            // Actualizar enlaces
            paymentUrlPreview.href = paymentUrl.value || '#';
            whatsappUrlPreview.href = whatsappUrl.value || '#';
        }
        
        // Actualizar vista previa de videos
        function updateVideosPreview() {
            // Actualizar videos
            const defenderEmbedUrl = convertToEmbedUrl(defenderVideoUrl.value);
            const esetEmbedUrl = convertToEmbedUrl(esetVideoUrl.value);
            
            defenderVideoPreview.src = defenderEmbedUrl;
            esetVideoPreview.src = esetEmbedUrl;
        }
        
        // Convertir URL de YouTube a formato de incrustación
        function convertToEmbedUrl(url) {
            if (!url) return '';
            
            // Si ya es una URL de incrustación, devolverla tal cual
            if (url.includes('youtube.com/embed/')) {
                return url;
            }
            
            // Extraer el ID del video de diferentes formatos de URL de YouTube
            let videoId = '';
            
            // Formato: https://www.youtube.com/watch?v=VIDEO_ID
            if (url.includes('youtube.com/watch')) {
                const urlParams = new URLSearchParams(new URL(url).search);
                videoId = urlParams.get('v');
            } 
            // Formato: https://youtu.be/VIDEO_ID
            else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            }
            
            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            
            // Si no se pudo extraer el ID, devolver la URL original
            return url;
        }
        
        // Funciones auxiliares
        function showLoading(show, title = 'Cargando configuración', message = 'Obteniendo datos desde SharePoint...') {
            if (show) {
                loadingTitle.textContent = title;
                loadingMessage.textContent = message;
                loadingState.classList.remove('d-none');
                document.body.style.overflow = 'hidden'; // Prevenir scroll
            } else {
                loadingState.classList.add('d-none');
                document.body.style.overflow = ''; // Restaurar scroll
            }
        }
        
        function updateProgress(percent, message) {
            loadingProgressBar.style.width = `${percent}%`;
            loadingProgressBar.setAttribute('aria-valuenow', percent);
            loadingProgressText.textContent = message;
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
        
        // Configurar eventos
        function setupEventListeners() {
            // Botón de guardar
            saveConfigButton.addEventListener('click', saveConfiguration);
            
            // Botón de actualizar
            refreshButton.addEventListener('click', loadConfiguration);
            
            // Eventos para actualizar vista previa del curso
            courseTitle.addEventListener('input', updateCoursePreview);
            courseDescription.addEventListener('input', updateCoursePreview);
            courseVideoUrl.addEventListener('input', updateCoursePreview);
            paymentUrl.addEventListener('input', updateCoursePreview);
            whatsappUrl.addEventListener('input', updateCoursePreview);
            
            // Eventos para actualizar vista previa de videos
            defenderVideoUrl.addEventListener('input', updateVideosPreview);
            esetVideoUrl.addEventListener('input', updateVideosPreview);
            
            // Botón para forzar conversión RTF a HTML
            document.getElementById('forceConversionBtn').addEventListener('click', forceRtfConversion);
            
            // Botón de cerrar sesión
            document.getElementById('logoutButton').addEventListener('click', function() {
                auth.logout();
            });
        }
        
        // Forzar conversión de RTF a HTML
        function forceRtfConversion() {
            try {
                console.log('Forzando conversión RTF a HTML...');
                
                if (!appSettings || !appSettings.TermsAndConditions || !appSettings.TermsAndConditions.Content) {
                    console.error('No hay contenido RTF disponible para convertir');
                    showAlert('danger', 'No hay contenido RTF disponible para convertir');
                    return;
                }
                
                console.log('Contenido RTF disponible, longitud:', appSettings.TermsAndConditions.Content.length);
                const rtfSample = appSettings.TermsAndConditions.Content.substring(0, 200) + '...';
                console.log('Muestra del RTF:', rtfSample);
                
                // Mostrar estado de carga
                showLoading(true, 'Convirtiendo RTF a HTML', 'Procesando contenido...');
                
                // Usar setTimeout para permitir que la UI se actualice
                setTimeout(() => {
                    try {
                        // Llamar a la función de conversión
                        const htmlContent = rtfToHtml(appSettings.TermsAndConditions.Content);
                        console.log('Conversión RTF a HTML completada');
                        
                        if (htmlContent && htmlContent.trim() !== '') {
                            console.log('HTML generado correctamente');
                            
                            // Actualizar el editor y la vista previa
                            termsEditor.innerHTML = htmlContent;
                            updateTermsPreview();
                            
                            // No guardar el HTML generado para evitar actualizaciones automáticas
                            
                            showLoading(false);
                            showAlert('success', 'Conversión RTF a HTML completada correctamente');
                        } else {
                            console.error('La conversión RTF a HTML no generó contenido válido');
                            showLoading(false);
                            showAlert('danger', 'La conversión no generó contenido HTML válido');
                        }
                    } catch (error) {
                        console.error('Error durante la conversión RTF a HTML:', error);
                        showLoading(false);
                        showAlert('danger', `Error durante la conversión: ${error.message}`);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error al forzar la conversión RTF a HTML:', error);
                showLoading(false);
                showAlert('danger', `Error: ${error.message}`);
            }
        }
        
        // Actualizar vista previa de términos y condiciones
        function updateTermsPreview() {
            termsPreview.innerHTML = termsEditor.innerHTML || 'No hay términos y condiciones definidos.';
        }
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log("Inicializando la aplicación...");
                
                // Inicializar editor básico
                initBasicEditor();
                
                // Inicializar autenticación
                auth = new SharePointAuth();
                
                try {
                    // Verificar si hay una respuesta de redirección o una sesión existente
                    await auth.initialize();
                    
                    // Verificar si el usuario está autenticado
                    if (!auth.isAuthenticated()) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Actualizar el nombre de usuario en la interfaz
                    const currentUserNameElement = document.getElementById('currentUserName');
                    if (currentUserNameElement && auth.user) {
                        currentUserNameElement.textContent = auth.user.name || auth.user.username;
                        console.log("Nombre de usuario actualizado:", auth.user.name || auth.user.username);
                    }
                    
                    // Inicializar componentes
                    spGraph = new SharePointGraph(auth);
                    window.spGraph = spGraph; // Hacer disponible globalmente
                    
                    // Configurar eventos
                    setupEventListeners();
                    
                    // Cargar configuración
                    await loadConfiguration();
                    
                } catch (error) {
                    console.error('Error al inicializar la aplicación:', error);
                    showAlert('danger', `Error al inicializar la aplicación: ${error.message}`);
                }
            } catch (error) {
                console.error('Error al inicializar la aplicación:', error);
                showAlert('danger', `Error al inicializar la aplicación: ${error.message}`);
            }
        });
    </script>
</body>
</html> 
